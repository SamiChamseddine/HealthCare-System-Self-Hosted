<Page x:Class="Florence.Desktop.Views.InvoiceForm"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:av="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:utils="clr-namespace:Florence.Desktop.Utils"
      xmlns:controls="clr-namespace:Florence.Desktop.Controls"
      mc:Ignorable="av"
      Title="Create Invoice"
      Focusable="True"
      FocusManager.IsFocusScope="True"
      Background="{DynamicResource MahApps.Brushes.ThemeBackground}">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <utils:DateOnlyConverter x:Key="DateOnlyConverter"/>

        <Style x:Key="ModernDataGrid" TargetType="DataGrid">
            <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Control.Background}"/>
            <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Text}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Control.Border}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
            <Setter Property="RowHeight" Value="38"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="AlternatingRowBackground" Value="{DynamicResource MahApps.Brushes.Control.Background2}"/>
            <Setter Property="RowBackground" Value="{DynamicResource MahApps.Brushes.Control.Background}"/>
            <Setter Property="ScrollViewer.CanContentScroll" Value="False"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>

        <Style x:Key="SummaryText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Text}"/>
        </Style>
    </Page.Resources>

    <Grid Margin="30" MouseDown="Grid_MouseDown" Background="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0"
                      VerticalScrollBarVisibility="Auto"
                      PanningMode="Both"
                      Focusable="False">
            <StackPanel>

                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <controls:BackToDashboardButton 
        Grid.Column="0"
        Margin="0,0,20,0"
        VerticalAlignment="Center"/>

                    <TextBlock Text="{Binding HeaderText}"
               Grid.Column="1"
               FontSize="22"
               FontWeight="Bold"
               Foreground="{DynamicResource MahApps.Brushes.Text}"
               VerticalAlignment="Center"/>
                </Grid>

                <Border Background="{DynamicResource MahApps.Brushes.Control.Background2}"
                        BorderBrush="{DynamicResource MahApps.Brushes.Control.Border}"
                        BorderThickness="1"
                        Padding="15"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="Customer *" Style="{StaticResource FormLabel}"/>
                        <ComboBox x:Name="CustomerComboBox"
          ItemsSource="{Binding Customers}"
          DisplayMemberPath="Name"
          SelectedValuePath="Id"
          SelectedValue="{Binding Invoice.CustomerId, Mode=TwoWay}"
          IsEditable="True"
          StaysOpenOnEdit="True"
          KeyUp="CustomerComboBox_KeyUp"
          DropDownOpened="CustomerComboBox_DropDownOpened"
          Style="{StaticResource FormComboBox}"
          Margin="0,5,0,0"/>
                    </StackPanel>
                </Border>

                <Border Background="{DynamicResource MahApps.Brushes.Control.Background2}"
                        BorderBrush="{DynamicResource MahApps.Brushes.Control.Border}"
                        BorderThickness="1"
                        Padding="15"
                        Margin="0,0,0,15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="4">
                            <TextBlock Text="Due Date *" Style="{StaticResource FormLabel}"/>
                            <DatePicker SelectedDate="{Binding Invoice.DueDate, Converter={StaticResource DateOnlyConverter}}"
                                        Style="{StaticResource FormDatePicker}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="4">
                            <TextBlock Text="Created At" Style="{StaticResource FormLabel}"/>
                            <DatePicker SelectedDate="{Binding Invoice.DateCreated,
                                   Converter={StaticResource DateOnlyConverter},
                                   Mode=TwoWay,
                                   ValidatesOnDataErrors=False,
                                   UpdateSourceTrigger=PropertyChanged}"
            Style="{StaticResource FormDatePicker}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Margin="4">
                            <TextBlock Text="VAT Rate (%)" Style="{StaticResource FormLabel}"/>
                            <TextBox x:Name="VatTextBox"
                                     Text="{Binding VatRateText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource FormTextBox}"
                                     TextAlignment="Right"
                                     PreviewTextInput="PercentageTextBox_PreviewTextInput"
                                     LostFocus="PercentageTextBox_LostFocus"/>
                        </StackPanel>

                        <StackPanel Grid.Column="3" Margin="4">
                            <TextBlock Text="Currency" Style="{StaticResource FormLabel}"/>
                            <ComboBox ItemsSource="{Binding Currencies}"
                                      SelectedValue="{Binding Invoice.Currency}"
                                      Style="{StaticResource FormComboBox}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="4" Margin="4">
                            <TextBlock Text="Discount (%)" Style="{StaticResource FormLabel}"/>
                            <TextBox x:Name="DiscountTextBox"
                                     Text="{Binding DiscountPercentText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource FormTextBox}"
                                     TextAlignment="Right"
                                     PreviewTextInput="PercentageTextBox_PreviewTextInput"
                                     LostFocus="PercentageTextBox_LostFocus"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <Border Background="{DynamicResource MahApps.Brushes.Control.Background2}"
                        BorderBrush="{DynamicResource MahApps.Brushes.Control.Border}"
                        BorderThickness="1"
                        Padding="15"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,10">
                            <TextBlock Text="Invoice Items *"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource MahApps.Brushes.Text}"
                                       DockPanel.Dock="Left"
                                       VerticalAlignment="Center"/>
                            <Button Content="+ Add Item"
                                    Command="{Binding AddItemCommand}"
                                    Style="{StaticResource PrimaryButton}"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"/>
                        </DockPanel>

                        <Border BorderBrush="{DynamicResource MahApps.Brushes.Control.Border}"
                                BorderThickness="1"
                                Background="{DynamicResource MahApps.Brushes.Control.Background}">
                            <DataGrid ItemsSource="{Binding Invoice.Items}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      HeadersVisibility="Column"
                                      GridLinesVisibility="None"
                                      IsReadOnly="False"
                                      Style="{StaticResource ModernDataGrid}"
                                      PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Description"
                                                        Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                                                        Width="2*" />
                                    <DataGridTextColumn Header="Qty"
                                                        Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                                                        Width="80" />
                                    <DataGridTextColumn Header="Unit Price"
                                                        Binding="{Binding UnitPrice, UpdateSourceTrigger=PropertyChanged}"
                                                        Width="120" />
                                    <DataGridTextColumn Header="Total"
                                                        Binding="{Binding Total}"
                                                        Width="120"
                                                        IsReadOnly="True" />
                                    <DataGridTemplateColumn Header="Action" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="Remove"
                                                        Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource DangerButton}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Border>
                    </StackPanel>
                </Border>

                <Border Background="{DynamicResource MahApps.Brushes.Control.Background2}"
                        BorderBrush="{DynamicResource MahApps.Brushes.Control.Border}"
                        BorderThickness="1"
                        Padding="15"
                        Margin="0,10,0,15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Subtotal:" Style="{StaticResource SummaryText}"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="{Binding Subtotal}" Style="{StaticResource SummaryText}"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Discount:" Style="{StaticResource SummaryText}"/>
                        <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding DiscountAmount}" Style="{StaticResource SummaryText}"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="VAT:" Style="{StaticResource SummaryText}"/>
                        <TextBlock Grid.Row="2" Grid.Column="2" Text="{Binding VatAmount}" Style="{StaticResource SummaryText}"/>

                        <Rectangle Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="3"
                                   Height="1"
                                   Fill="{DynamicResource MahApps.Brushes.Control.Border}"
                                   Margin="0,5,0,5"/>

                        <TextBlock Grid.Row="4" Grid.Column="0"
                                   Text="Total:"
                                   FontWeight="Bold"
                                   FontSize="16"
                                   Foreground="{DynamicResource MahApps.Brushes.Highlight}"/>
                        <TextBlock Grid.Row="4" Grid.Column="2"
                                   Text="{Binding Total}"
                                   FontWeight="Bold"
                                   FontSize="16"
                                   Foreground="{DynamicResource MahApps.Brushes.Highlight}"/>
                    </Grid>
                </Border>

                <TextBlock Text="{Binding Error}"
                           Foreground="#E57373"
                           FontWeight="SemiBold"
                           Visibility="{Binding HasErrors, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
        </ScrollViewer>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
            <Button Content="Save"
                    Command="{Binding SaveCommand}"
                    Style="{StaticResource PrimaryButton}"
                    Margin="0,0,10,0"/>
            <Button Content="Clear"
                    Command="{Binding ClearCommand}"
                    Style="{StaticResource SecondaryButton}"/>
        </StackPanel>
    </Grid>
</Page>